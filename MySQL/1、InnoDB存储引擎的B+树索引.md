# 1 B+树的数据结构
## 1.1 数据结构
`B+树`是为磁盘或其他直接存取辅助设备设计的一种平衡查找树。

B+树的`B`指的是平衡（Balance）。

在B+树中，所有`记录节点`都是按`键值`的大小顺序存放在同一层的`叶子节点`上，由各个叶子节点`指针`进行连接。

根据叶子节点的大小和数量，会选取各个叶子节点的`首个键值`构造出上一层父节点。

同样，根据上一层父节点的大小和数量，也会选取各个父节点的`首个键值`继续构造出再上一层父节点。

如此反复，直至最上一层父节点的数量为1，此时称该父节点为`根节点`。

![[Pasted image 20230212132727.png]]



## 1.2 树操作

## 1.3 为什么使用B+树
MySQL的数据都是储存在磁盘中的，逻辑上称为`表空间`。

表空间又由段、区和页构成，它们之间存在父子包容关系：
- 表空间由多个段组成。
- 段由多个区组成。
- 区由多个连续的页组成。
- 页是InnoDB磁盘管理的最小单位。

段分为：数据段、索引段和回滚段等。在B+树索引中，非叶子节点就存在于索引段中，而叶子节点存在于数据段中。

区的大小固定为1M，它由多个连续的页组成。

页的默认大小是16KB，可以通过设置参数`innodb_page_size`修改为4K、8K或16K。

根据所处段逻辑的不同，每个页会存储不同含义的数据，例如存储索引和记录的数据页（B-tree Node）。

在页的内部，它会按行存储数据，`行记录`有特定的格式。由于页的大小是固定的，所以行数会随着行记录的大小而改变。

在B+树索引中，每个节点表示一个磁盘中的页。对于一个查询语句，MySQL会按照如下顺序进行操作：
1. 读取根节点磁盘页到内存，通过计算找到子节点所在磁盘页的指针。
2. 读取子节点磁盘页到内存，通过计算找到下一个子节点所在磁盘页的指针。
3. ……
4. 读取叶子节点磁盘页到内存，通过计算找到所需要的行记录，返回数据。

因此，每次读取节点都表示一次磁盘IO操作，所以树的高度可以代表查找数据的次数。

为了减小磁盘IO操作次数，需要减小树的高度，B+树只在叶子节点的行记录中保存完整数据，而在非叶子节点的行记录中只保存`索引键值`和`子节点指针`。由于页的大小是固定的，行记录变小了，每页能存储的行记录就变多了。这样一来，B+树每层的扇出就变大了，大大减小了树的高度，大大减小了磁盘IO操作的次数，大大提高了查询数据的效率。

此外，B+树的叶子节点之间通过指针进行连接。对于范围查询来说，如果数据分布在连续的多个页中，MySQL不必回表查询索引页，可以直接根据指针查询下一页的数据。



# 2 B+树索引


# 2 全文索引
